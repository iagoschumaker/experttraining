generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  name          String
  email         String         @unique
  passwordHash  String         @map("password_hash")
  isSuperAdmin  Boolean        @default(false) @map("is_superadmin")
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  auditLogs     AuditLog[]
  clients       Client[]       @relation("ClientTrainer")
  lessons       Lesson[]
  refreshTokens RefreshToken[]
  studios       UserStudio[]

  @@map("users")
}

model Studio {
  id              String        @id @default(cuid())
  name            String
  slug            String        @unique
  status          StudioStatus  @default(ACTIVE)
  planId          String?       @map("plan_id")
  logoUrl         String?       @map("logo_url")
  settings        Json?         @default("{}")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  blockedAt       DateTime?     @map("blocked_at")
  blockedReason   String?       @map("blocked_reason")
  gracePeriodEnds DateTime?     @map("grace_period_ends")
  isPaid          Boolean       @default(true) @map("is_paid")
  lastPaymentDate DateTime?     @map("last_payment_date")
  paymentDueDate  DateTime?     @map("payment_due_date")
  paymentNotes    String?       @map("payment_notes")
  auditLogs       AuditLog[]
  clients         Client[]
  lessons         Lesson[]
  plan            Plan?         @relation(fields: [planId], references: [id])
  subscriptions   Subscription?
  users           UserStudio[]
  workouts        Workout[]

  @@index([isPaid])
  @@index([paymentDueDate])
  @@map("studios")
}

model UserStudio {
  id        String         @id @default(cuid())
  userId    String         @map("user_id")
  studioId  String         @map("studio_id")
  role      UserStudioRole
  isActive  Boolean        @default(true) @map("is_active")
  joinedAt  DateTime       @default(now()) @map("joined_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  studio    Studio         @relation(fields: [studioId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, studioId])
  @@index([userId])
  @@index([studioId])
  @@map("user_studios")
}

model Plan {
  id              String         @id @default(cuid())
  name            String
  description     String?
  features        Json           @default("[]")
  isActive        Boolean        @default(true) @map("is_active")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  billingRules    Json           @default("{}") @map("billing_rules")
  isVisible       Boolean        @default(true) @map("is_visible")
  minTrainers     Int            @default(1) @map("min_trainers")
  pricePerTrainer Decimal        @map("price_per_trainer") @db.Decimal(10, 2)
  recommendedMax  Int?           @map("recommended_max")
  slug            String         @unique
  tier            PlanTier       @default(START)
  studios         Studio[]
  subscriptions   Subscription[]

  @@map("plans")
}

model Subscription {
  id                 String             @id @default(cuid())
  studioId           String             @unique @map("studio_id")
  planId             String             @map("plan_id")
  status             SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  nextBillingDate    DateTime           @map("next_billing_date")
  autoRenew          Boolean            @default(true) @map("auto_renew")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  canceledAt         DateTime?          @map("canceled_at")
  cancelReason       String?            @map("cancel_reason")
  metadata           Json?              @default("{}")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  invoices           Invoice[]
  plan               Plan               @relation(fields: [planId], references: [id])
  studio             Studio             @relation(fields: [studioId], references: [id], onDelete: Cascade)
  usageRecords       UsageRecord[]

  @@index([status])
  @@index([nextBillingDate])
  @@map("subscriptions")
}

model UsageRecord {
  id               String       @id @default(cuid())
  subscriptionId   String       @map("subscription_id")
  studioId         String       @map("studio_id")
  periodStart      DateTime     @map("period_start")
  periodEnd        DateTime     @map("period_end")
  activeTrainers   Int          @map("active_trainers")
  totalTrainers    Int          @map("total_trainers")
  trainerActivity  Json         @map("trainer_activity")
  totalLessons     Int          @default(0) @map("total_lessons")
  totalAssessments Int          @default(0) @map("total_assessments")
  totalWorkouts    Int          @default(0) @map("total_workouts")
  totalClients     Int          @default(0) @map("total_clients")
  pricePerTrainer  Decimal      @map("price_per_trainer") @db.Decimal(10, 2)
  totalAmount      Decimal      @map("total_amount") @db.Decimal(10, 2)
  isBilled         Boolean      @default(false) @map("is_billed")
  invoiceId        String?      @map("invoice_id")
  recordedAt       DateTime     @default(now()) @map("recorded_at")
  createdAt        DateTime     @default(now()) @map("created_at")
  invoice          Invoice?     @relation(fields: [invoiceId], references: [id])
  subscription     Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([studioId])
  @@index([periodStart])
  @@index([periodEnd])
  @@map("usage_records")
}

model Invoice {
  id             String        @id @default(cuid())
  subscriptionId String        @map("subscription_id")
  studioId       String        @map("studio_id")
  invoiceNumber  String        @unique @map("invoice_number")
  periodStart    DateTime      @map("period_start")
  periodEnd      DateTime      @map("period_end")
  subtotal       Decimal       @db.Decimal(10, 2)
  discount       Decimal       @default(0) @db.Decimal(10, 2)
  tax            Decimal       @default(0) @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  items          Json
  status         InvoiceStatus @default(PENDING)
  dueDate        DateTime      @map("due_date")
  paidAt         DateTime?     @map("paid_at")
  paymentMethod  String?       @map("payment_method")
  paymentId      String?       @map("payment_id")
  notes          String?
  metadata       Json?         @default("{}")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  subscription   Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  usageRecords   UsageRecord[]

  @@index([subscriptionId])
  @@index([studioId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model StudioSubscription {
  id             String   @id @default(cuid())
  studioId       String   @unique @map("studio_id")
  subscriptionId String   @map("subscription_id")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("studio_subscriptions")
}

model Client {
  id            String         @id @default(cuid())
  studioId      String         @map("studio_id")
  trainerId     String?        @map("trainer_id")
  name          String
  email         String?
  phone         String?
  birthDate     DateTime?      @map("birth_date")
  gender        String?
  height        Decimal?       @db.Decimal(5, 2)
  weight        Decimal?       @db.Decimal(5, 2)
  bodyFat       Decimal?       @map("body_fat") @db.Decimal(5, 2)
  history       String?
  objectives    String?
  notes         String?
  goal          String?
  goalType      GoalType?      @map("goal_type")
  goalWeight    Decimal?       @map("goal_weight") @db.Decimal(5, 2)
  status        ClientStatus   @default(ACTIVE)
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  arm           Decimal?       @db.Decimal(5, 2)
  calf          Decimal?       @db.Decimal(5, 2)
  chest         Decimal?       @db.Decimal(5, 2)
  hip           Decimal?       @db.Decimal(5, 2)
  thigh         Decimal?       @db.Decimal(5, 2)
  waist         Decimal?       @db.Decimal(5, 2)
  assessments   Assessment[]
  studio        Studio         @relation(fields: [studioId], references: [id], onDelete: Cascade)
  trainer       User?          @relation("ClientTrainer", fields: [trainerId], references: [id])
  lessonClients LessonClient[]
  workouts      Workout[]

  @@index([studioId])
  @@index([trainerId])
  @@map("clients")
}

model Assessment {
  id              String           @id @default(cuid())
  clientId        String           @map("client_id")
  assessorId      String           @map("assessor_id")
  status          AssessmentStatus @default(PENDING)
  inputJson       Json             @map("input_json")
  resultJson      Json?            @map("result_json")
  confidence      Decimal?         @db.Decimal(5, 2)
  completedAt     DateTime?        @map("completed_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  bodyMetricsJson Json?            @map("body_metrics_json")
  computedJson    Json?            @map("computed_json")
  performanceJson Json?            @map("performance_json")
  client          Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([assessorId])
  @@index([clientId, createdAt])
  @@map("assessments")
}

model Block {
  id                      String     @id @default(cuid())
  code                    String     @unique
  name                    String
  description             String?
  isLocked                Boolean    @default(true) @map("is_locked")
  createdBy               String     @default("SUPERADMIN") @map("created_by")
  sourceSheet             String?    @map("source_sheet")
  levelMin                Int        @default(1) @map("level_min")
  levelMax                Int?       @map("level_max")
  phase                   String?
  level                   Int        @default(1)
  levelName               String?    @map("level_name")
  trainingIntent          String?    @map("training_intent")
  blockRoleInSession      String?    @map("block_role_in_session")
  primaryCapacity         String     @map("primary_capacity")
  secondaryCapacities     String[]   @map("secondary_capacities")
  fatigueLevel            String?    @map("fatigue_level")
  cardiorespiratoryDemand String?    @map("cardiorespiratory_demand")
  neuromuscularDemand     String?    @map("neuromuscular_demand")
  axialLoad               String?    @map("axial_load")
  impactLevel             String?    @map("impact_level")
  jointStress             String[]   @default([]) @map("joint_stress")
  complexity              Int        @default(1)
  impact                  Int        @default(1)
  movementPattern         String?    @map("movement_pattern")
  riskLevel               RiskLevel  @default(LOW) @map("risk_level")
  suggestedFrequency      Int?       @map("suggested_frequency")
  estimatedDuration       Int?       @map("estimated_duration")
  blockOrder              Int?       @map("block_order")
  prerequisites           Json?      @default("{}")
  blockedIf               Json?      @default("[]") @map("blocked_if")
  allowedIf               Json?      @default("[]") @map("allowed_if")
  contraindications       Json?      @default("[]")
  exercises               Json       @default("[]")
  prerequisiteBlockId     String?    @map("prerequisite_block_id")
  progressionBlockId      String?    @map("progression_block_id")
  isActive                Boolean    @default(true) @map("is_active")
  createdAt               DateTime   @default(now()) @map("created_at")
  updatedAt               DateTime   @updatedAt @map("updated_at")
  prerequisiteBlock       Block?     @relation("BlockProgression", fields: [prerequisiteBlockId], references: [id])
  progressionBlocks       Block[]    @relation("BlockProgression")
  exercisesList           Exercise[]

  @@index([primaryCapacity])
  @@index([level])
  @@index([levelMin])
  @@index([trainingIntent])
  @@index([blockRoleInSession])
  @@index([isLocked])
  @@map("blocks")
}

model Exercise {
  id             String   @id @default(cuid())
  name           String
  description    String?
  isLocked       Boolean  @default(true) @map("is_locked")
  createdBy      String   @default("SUPERADMIN") @map("created_by")
  type           String?
  muscleGroup    String?  @map("muscle_group")
  equipment      String?
  difficulty     String?
  defaultSets    Int?     @map("default_sets")
  defaultReps    String?  @map("default_reps")
  defaultTime    String?  @map("default_time")
  defaultRest    String?  @map("default_rest")
  technicalNotes String?  @map("technical_notes")
  instructions   String?
  videoUrl       String?  @map("video_url")
  orderInBlock   Int?     @map("order_in_block")
  blockId        String?  @map("block_id")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  block          Block?   @relation(fields: [blockId], references: [id])

  @@index([blockId])
  @@index([muscleGroup])
  @@index([isLocked])
  @@map("exercises")
}

model Rule {
  id              String   @id @default(cuid())
  name            String
  description     String?
  isLocked        Boolean  @default(true) @map("is_locked")
  createdBy       String   @default("SUPERADMIN") @map("created_by")
  conditionJson   Json     @map("condition_json")
  allowedBlocks   String[] @map("allowed_blocks")
  blockedBlocks   String[] @map("blocked_blocks")
  recommendations String[] @default([])
  priority        Int      @default(0)
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([priority])
  @@map("rules")
}

model Workout {
  id           String    @id @default(cuid())
  clientId     String    @map("client_id")
  studioId     String    @map("studio_id")
  createdById  String    @map("created_by_id")
  name         String?
  blocksUsed   String[]  @map("blocks_used")
  scheduleJson Json      @map("schedule_json")
  startDate    DateTime? @map("start_date")
  endDate      DateTime? @map("end_date")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  client       Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  studio       Studio    @relation(fields: [studioId], references: [id], onDelete: Cascade)
  lessons      Lesson[]  // Aulas derivadas deste treino

  @@index([clientId])
  @@index([studioId])
  @@map("workouts")
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  userAgent String?   @map("user_agent")
  ipAddress String?   @map("ip_address")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  studioId  String?  @map("studio_id")
  action    String
  entity    String
  entityId  String?  @map("entity_id")
  oldData   Json?    @map("old_data")
  newData   Json?    @map("new_data")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")
  studio    Studio?  @relation(fields: [studioId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([studioId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

model Lesson {
  id              String         @id @default(cuid())
  studioId        String         @map("studio_id")
  trainerId       String         @map("trainer_id")
  type            LessonType     @default(INDIVIDUAL)
  photoUrl        String?        @map("photo_url")
  photoKey        String?        @map("photo_key")
  
  // Campos de data/hora - OBRIGATÓRIOS para rastreamento
  date            DateTime       @map("lesson_date") @db.Date // Data da aula (YYYY-MM-DD)
  startedAt       DateTime       @default(now()) @map("started_at") // DateTime completo de início
  endedAt         DateTime?      @map("ended_at") // DateTime completo de término
  duration        Int?           // Duração em minutos (calculada automaticamente)
  
  // Campos do cronograma - derivados do treino ativo
  workoutId       String?        @map("workout_id") // Treino de origem
  weekIndex       Int?           @map("week_index") // Semana do cronograma (1-4)
  dayIndex        Int?           @map("day_index") // Dia do cronograma (1-7)
  focus           String?        // Foco principal do treino (PERNA, SUPERIOR, etc.)
  
  notes           String?
  status          LessonStatus   @default(STARTED)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  
  clients         LessonClient[]
  studio          Studio         @relation(fields: [studioId], references: [id], onDelete: Cascade)
  trainer         User           @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  workout         Workout?       @relation(fields: [workoutId], references: [id], onDelete: SetNull)

  @@index([studioId])
  @@index([trainerId])
  @@index([startedAt])
  @@index([status])
  @@index([date])
  @@index([workoutId])
  @@map("lessons")
}

model LessonClient {
  id        String   @id @default(cuid())
  lessonId  String   @map("lesson_id")
  clientId  String   @map("client_id")
  attended  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, clientId])
  @@index([lessonId])
  @@index([clientId])
  @@map("lesson_clients")
}

enum StudioStatus {
  ACTIVE
  SUSPENDED
  GRACE_PERIOD
  CANCELED
}

enum UserStudioRole {
  STUDIO_ADMIN
  TRAINER
}

enum RiskLevel {
  LOW
  MODERATE
  HIGH
  CRITICAL
}

enum AssessmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum GoalType {
  WEIGHT_LOSS
  MUSCLE_GAIN
  RECOMP
  PERFORMANCE
  HEALTH
}

enum PlanTier {
  START
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELED
  REFUNDED
}

enum LessonType {
  INDIVIDUAL
  GROUP
}

enum LessonStatus {
  STARTED
  COMPLETED
  CANCELLED
}
